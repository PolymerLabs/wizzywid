<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="code-view">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }
    </style>
    <div id="__editor" style="height: 100%; width:100%"></div>
  </template>
  <script>
    class CodeView extends Polymer.Element {
      static get is() { return 'code-view'; }

      // Yeah so Ace editor doesn't work with shadow roots because
      // it probably does a document.getElementById in the edit function.
      _attachDom(dom) {
        return this.appendChild(dom);
      }

      connectedCallback() {
        super.connectedCallback();
        this._propertyDefaultsForTag = {};
        this._attributeDefaultsForTag = {};

        this._aceEditor = ace.edit('__editor');
        this._aceEditor.setReadOnly(true);
        this._aceEditor.setTheme("ace/theme/monokai");
        this._aceEditor.getSession().setMode("ace/mode/html");
        this._aceEditor.$blockScrolling = Infinity;
        this._aceEditor.setOptions({fontSize: "14px"});
      }

      update(code) {
        this._aceEditor.setValue(code);
        this._aceEditor.clearSelection();
      }

      has(tag) {
        return !!this._propertyDefaultsForTag[tag];
      }

      save(tag, packageName, el) {
        if (this._propertyDefaultsForTag[tag]) {
          return;
        }

        this._propertyDefaultsForTag[tag] = {};
        this._attributeDefaultsForTag[tag] = {};

        if (!packageName) {
          // TODO: woof, this is bad.
          packageName = window.shell.$.custom.namesToPackages[tag];
          // If you still didn't find an answer, default to the tag name.
          if (!packageName) {
            packageName = tag;
          }
        }
        this._propertyDefaultsForTag[tag]['__package_name__'] = packageName;

        var props = getProtoProperties(el);
        var attributes = getAttributesIfCustomElement(el);

        let propsKeys = ['id', 'slot', 'classList'].concat(props);

        // Property defaults
        for (let i = 0; i < propsKeys.length; i++) {
          let prop = propsKeys[i];
          if (prop === 'classList') {
            this._propertyDefaultsForTag[tag][prop] = el[prop].value;
          } else {
            this._propertyDefaultsForTag[tag][prop] = el[prop];
          }
        }

        // Attribute defaults.
        for (let i = 0; i < attributes.length; i++) {
          let attr = attributes[i];
          this._attributeDefaultsForTag[tag][attr] = el.getAttribute(attr);
        }
      }

      get(parent, usePolygit) {
        // Imports. Yes i'm using element globals because I'm lazy. Fight me.
        this._imports = '';
        this._template = '';
        this._style = '';

        // Host styles.
        let hostCss = parent.style.cssText.replace(/;/g, `;\n       `).trim();
        let bonusHost = `        ${hostCss}`;

        let polygitBase = '';
        var directoryPrefix = usePolygit ? '' : 'bower_components/';
        if (usePolygit) {
          polygitBase = '<base href="https://polygit.org/polymer+:master/webcomponents+:master/shadycss+webcomponents+:master/paper*+polymerelements+:master/iron*+polymerelements+:master/app*+polymerelements+:master/neon*+polymerelements+:master/components/">';
        }

        this.dumpNode(parent, '    ', directoryPrefix);

        let domModule = `
<dom-module id="main-app">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
${bonusHost.trimRight()}
      }
${this._style.trimRight()}
    </style>
${this._template.trimRight()}
  </template>
  <script>
    window.addEventListener('WebComponentsReady', function() {
      class MainApp extends Polymer.Element {
        static get is() { return 'main-app'; }
      }

      customElements.define(MainApp.is, MainApp);
    });
  &lt;/script>
</dom-module>`;
        let appTitle = 'wizzywid output';
        let html = `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
<title>${appTitle}</title>
${polygitBase}
<script src="${directoryPrefix}webcomponentsjs/webcomponents-loader.js">&lt;/script>
<link rel="import" href="${directoryPrefix}polymer/polymer-element.html">
${this._imports.trimRight()}
<style>
  body {
    margin: 0;
    font-family: 'Roboto', 'Noto', sans-serif;
    line-height: 1.5;
    background-color: white;
  }
</style>
</head>
<body>

<main-app></main-app>
${domModule}
</body>
</html>`;
        return html.replace(/&lt;/g, '<');
      }

      dump(parent) {
        this.update(this.get(parent));
      }

      dumpNode(parent, indent, directoryPrefix) {
        let nodes = parent.children;

        for (let i = 0; i < nodes.length; i++) {
          // Add to the import if needed.
          let tag = nodes[i].tagName.toLowerCase();

          if (tag === 'style') {
            // Need to indent it
            this._style += nodes[i].textContent.replace(/[\n\r]/g, '\n    ') + '\n';
            continue;
          } else if (tag !== 'iron-icons' && tag.indexOf('-icons') !== -1) {
            // This is not actually an element, it's just an import.
            this._imports += this.dumpImports(tag, '', directoryPrefix) + '\n';
            continue;
          }

          if (tag.indexOf('-') !== -1 && this._imports.indexOf(`${tag}.html`) === -1) {
            this._imports += this.dumpImports(tag, '', directoryPrefix) + '\n';
          }
          this._style += this.dumpStyle(tag, nodes[i], '      ');

          // If this element doesn't have children, do it on one line.
          this._template += this.dumpElementStartTag(tag, nodes[i], indent);
          if (nodes[i].children.length == 0) {
            this._template += this.dumpElementText(tag, nodes[i], '');
            this._template += this.dumpElementEndTag(tag, nodes[i], '') + '\n';
          }
          else {
            this._template += '\n'
            this.dumpNode(nodes[i], indent + '  ', directoryPrefix) + '\n';
            this._template += this.dumpElementEndTag(tag, nodes[i], indent) + '\n';
          }
        }
      }

      dumpElementText(tag, node, indent) {
        let text = node.textContent.trim();
        if (text && node.children.length === 0) {
          return `${indent}${text}`
        } else {
          return '';
        }
      }
      dumpElementStartTag(tag, node, indent) {
        let str = this.dumpPropsAndAttributes(tag, node);
        return str.length === 0 ?
            `${indent}<${tag}>` :
            `${indent}<${tag} ${str}>`;
      }

      dumpElementEndTag(tag, node, indent) {
        return (tag === 'input' || tag === 'img') ? '' : `${indent}</${tag}>`;
      }

      dumpStyle(tag, node, indent) {
        let css = node.style.cssText.replace(/;/g, `;\n${indent} `).trim();
        if (css === '') {
          return '';
        }
        let id = node.id ? '#' + node.id : '';
        return `${indent}${tag}${id} {
${indent}  ${css}
${indent}}
`
      }

      dumpPropsAndAttributes(tag, node) {
        let str = '';
        if (!this._propertyDefaultsForTag[tag]) {
          this._doDefaultsForUnseenTag(tag);
        }

        // Do attributes first. For custom elements we should skip setting
        // properties because we don't know how they're converted to
        // attributes (Polymer camel cases). Also you're actually setting
        // attributes in the UI, so it doesn't make sense to look at props.
        let attrs = Object.keys(this._attributeDefaultsForTag[tag]);

        for (let i = 0; i < attrs.length; i++) {
          let name = attrs[i];
          let value = node.getAttribute(name);

          if (value === true || value === "") {
            str += `${name} `;
          } else if (tag === 'iron-ajax' && name === 'params' && value && value.indexOf('[[') !== -1) {
            // TODO: remove this enormous hack I added for the demo.
            // Problem: in order to put a data binding inside of the params attribute
            // which is an object, I need to use $= Ugh.
            str += `${name}$="${value}" `
          } else if (this._attributeDefaultsForTag[tag][name] != value) {
            str += `${name}="${value}" `
          }
        }

        // If this is a custom element, we can stop. (native elements only
        // have properties saved)
        if (tag.indexOf('-') !== -1) {
          return str;
        }

        let props = Object.keys(this._propertyDefaultsForTag[tag]);

        for (let i = 0; i < props.length; i++) {
          let name = props[i];
          let value = node[name];

          // If this property was already an attribute, skip it.
          if (attrs.indexOf(name) !== -1) {
            continue;
          }

          if (name === '__package_name__') {
            continue;
          } else if (name === 'classList') {
            // classList is special. Also 'active' is an internal value, so skip that.
            value = value.value; // classList is an array, surprise!
            value = value.replace('active', '').trim();
            if (value.length !== 0) {
              str += `class="${value}" `
            }
          } else if (value === true) {
            str += `${name} `;
          } else if (this._propertyDefaultsForTag[tag][name] != value) {
            str += `${name}="${value}" `
          }
        }
        return str.trim();
      }

      dumpImports(tag, indent, directoryPrefix) {
        if (!this._propertyDefaultsForTag[tag]) {
          this._doDefaultsForUnseenTag(tag);
        }
        let packageName = this._propertyDefaultsForTag[tag]['__package_name__'];
        // If this is app-layout stuff, it needs an extra package name.
        if (packageName === 'app-header' || packageName === 'app-drawer' || packageName === 'app-toolbar') {
          packageName = 'app-layout/' + packageName;
        } else if (packageName === '') {
          packageName = tag;
        }

        return `${indent}<link rel="import" href="${directoryPrefix}${packageName}/${tag}.html">`;
      }

      _doDefaultsForUnseenTag(tag) {
        let el = document.createElement(tag);
        this.save(tag, undefined, el);
      }
    }
    customElements.define(CodeView.is, CodeView);
  </script>
</dom-module>
